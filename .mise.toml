[tools]
rust = { version = "1.93", components = "rust-analyzer" }
tombi = "0.7"
prek = "0.3"
biome = "2"
cargo-binstall = "1"
"cargo:cargo-edit" = "0.13"
"cargo:cargo-machete" = "0.9"

[settings]
experimental = true

[env]
_.file = ".env"

[tasks.dev]
description = "Run development server"
run = "cargo run"

[tasks.dev-release]
description = "Run optimized release binary"
run = "cargo run --release"

[tasks.fmt]
description = "Format all files"
run = [
  "cargo fmt",
  "tombi format *.toml",
  "biome format --write",
]

[tasks.fmt-check]
description = "Check formatting without writing"
run = [
  "cargo fmt --check",
  "tombi format --check *.toml",
  "biome format",
]

[tasks.lint]
description = "Run all linters"
run = [
  "biome check",
  "cargo clippy -- -D warnings",
]

[tasks.test]
description = "Run tests"
run = "cargo test"

[tasks.build]
description = "Build debug binary"
run = "cargo build"

[tasks.build-release]
description = "Build optimized release binary"
run = "cargo build --release"

[tasks.docker]
description = "Build and run with Docker Compose"
run = "docker compose up -d --build"

[tasks.release]
description = "Tag and create GitHub release from Cargo.toml version"
run = """
#!/usr/bin/env bash
set -euo pipefail
version=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name=="tty1") | .version')
tag="v${version}"
if git tag -l "$tag" | grep -q .; then
  echo "Tag $tag already exists" >&2
  exit 1
fi
git tag "$tag"
git push --tags
gh release create "$tag" --title "$tag" --generate-notes
echo "Released $tag"
"""
